/*
        Leaflet.contextmenu, a context menu for Leaflet.
        (c) 2013, Adam Ratcliffe, GeoSmart Maps Limited
*/
L.Map.mergeOptions({contextmenuItems:[]});L.Map.ContextMenu=L.Handler.extend({statics:{BASE_CLS:"leaflet-contextmenu"},initialize:function(e){L.Handler.prototype.initialize.call(this,e);this._items=[];this._visible=false;var t=this._container=L.DomUtil.create("div",L.Map.ContextMenu.BASE_CLS,e._container);t.style.zIndex=1e4;t.style.position="absolute";if(e.options.contextmenuWidth){t.style.width=e.options.contextmenuWidth+"px"}this._createItems();L.DomEvent.on(t,"click",L.DomEvent.stop).on(t,"mousedown",L.DomEvent.stop).on(t,"dblclick",L.DomEvent.stop).on(t,"contextmenu",L.DomEvent.stop)},addHooks:function(){L.DomEvent.on(document,"keydown",this._onKeyDown,this);this._map.on({contextmenu:this._show,mouseout:this._hide,mousedown:this._hide,movestart:this._hide,zoomstart:this._hide},this)},removeHooks:function(){L.DomEvent.off(document,"keydown",this._onKeyDown,this);this._map.off({contextmenu:this._show,mouseout:this._hide,mousedown:this._hide,movestart:this._hide,zoomstart:this._hide},this)},showAt:function(e,t){if(e instanceof L.LatLng){e=this._map.latLngToContainerPoint(e)}this._showAtPoint(e,t)},hide:function(){this._hide()},addItem:function(e){return this.insertItem(e)},insertItem:function(e,t){t=t!==undefined?t:this._items.length;var n=this._createItem(this._container,e,t);this._items.push(n);this._sizeChanged=true;this._map.fire("contextmenu.additem",{contextmenu:this,el:n.el,index:t});return n.el},removeItem:function(e){var t=this._container;if(!isNaN(e)){e=t.children[e]}if(e){this._removeItem(L.Util.stamp(e));this._sizeChanged=true;this._map.fire("contextmenu.removeitem",{contextmenu:this,el:e})}},removeAllItems:function(){var e;while(this._container.children.length){e=this._container.children[0];this._removeItem(L.Util.stamp(e))}},setDisabled:function(e,t){var n=this._container,r=L.Map.ContextMenu.BASE_CLS+"-item";if(!isNaN(e)){e=n.children[e]}if(e&&L.DomUtil.hasClass(e,r)){if(t){L.DomUtil.addClass(e,r+"-disabled");this._map.fire("contextmenu.disableitem",{contextmenu:this,el:e})}else{L.DomUtil.removeClass(e,r+"-disabled");this._map.fire("contextmenu.enableitem",{contextmenu:this,el:e})}}},isVisible:function(){return this._visible},_createItems:function(){var e=this._map.options.contextmenuItems,t,n,r;for(n=0,r=e.length;n<r;n++){this._items.push(this._createItem(this._container,e[n]))}},_createItem:function(e,t,n){if(t.separator||t==="-"){return this._createSeparator(e,n)}var r=L.Map.ContextMenu.BASE_CLS+"-item",i=t.disabled?r+" "+r+"-disabled":r,s=this._insertElementAt("a",i,e,n),o=this._createEventHandler(s,t.callback,t.context),u="";if(t.icon){u='<img class="'+L.Map.ContextMenu.BASE_CLS+'-icon" src="'+t.icon+'"/>'}else if(t.iconCls){u='<span class="'+L.Map.ContextMenu.BASE_CLS+"-icon "+t.iconCls+'"></span>'}s.innerHTML=u+t.text;s.href="#";L.DomEvent.on(s,"click",L.DomEvent.stopPropagation).on(s,"mousedown",L.DomEvent.stopPropagation).on(s,"dblclick",L.DomEvent.stopPropagation).on(s,"click",L.DomEvent.preventDefault).on(s,"click",o);return{id:L.Util.stamp(s),el:s,callback:o}},_removeItem:function(e){var t,n,r,i;for(r=0,i=this._items.length;r<i;r++){t=this._items[r];if(t.id===e){n=t.el;callback=t.callback;if(callback){L.DomEvent.off(n,"click",L.DomEvent.stopPropagation).off(n,"mousedown",L.DomEvent.stopPropagation).off(n,"dblclick",L.DomEvent.stopPropagation).off(n,"click",L.DomEvent.preventDefault).off(n,"click",t.callback)}this._container.removeChild(n);this._items.splice(r,1);return t}}return null},_createSeparator:function(e,t){var n=this._insertElementAt("div",L.Map.ContextMenu.BASE_CLS+"-separator",e,t);return{id:L.Util.stamp(n),el:n}},_createEventHandler:function(e,t,n){var r=this,i=this._map,s=L.Map.ContextMenu.BASE_CLS+"-item-disabled";return function(o){if(L.DomUtil.hasClass(e,s)){return}r._hide();t.call(n||i,r._showLocation);r._map.fire("contextmenu:select",{contextmenu:r,el:e})}},_insertElementAt:function(e,t,n,r){var i,s=document.createElement(e);s.className=t;if(r!==undefined){i=n.children[r]}if(i){n.insertBefore(s,i)}else{n.appendChild(s)}return s},_show:function(e){this._showAtPoint(e.containerPoint)},_showAtPoint:function(e,t){if(!this._visible&&this._items.length){var n=this._map,r=n.containerPointToLayerPoint(e),i=n.layerPointToLatLng(r),s={contextmenu:this};if(t){s=L.extend(t,s)}this._showLocation={latlng:i,layerPoint:r,containerPoint:e};this._setPosition(e);this._container.style.display="block";this._visible=true;this._map.fire("contextmenu.show",s)}},_hide:function(){if(this._visible){this._container.style.display="none";this._visible=false;this._map.fire("contextmenu.hide",{contextmenu:this})}},_setPosition:function(e){var t=this._map.getSize(),n=this._container,r=this._getElementSize(n);n._leaflet_pos=e;if(e.x+r.x>t.x){n.style.left="auto";n.style.right=t.x-e.x+"px"}else{n.style.left=e.x+"px";n.style.right="auto"}if(e.y+r.y>t.y){n.style.top="auto";n.style.bottom=t.y-e.y+"px"}else{n.style.top=e.y+"px";n.style.bottom="auto"}},_getElementSize:function(e){var t=this._size;if(!t||this._sizeChanged){t={};e.style.left="-999999px";e.style.right="auto";e.style.display="block";t.x=e.offsetWidth;t.y=e.offsetHeight;e.style.left="auto";e.style.display="none";this._sizeChanged=false}return t},_onKeyDown:function(e){var t=e.keyCode;if(t===27&&this._visible){this._hide()}}});L.Map.addInitHook("addHandler","contextmenu",L.Map.ContextMenu);L.Mixin.ContextMenu={_initContextMenu:function(){this._items=[];this.on("contextmenu",this._showContextMenu,this)},_showContextMenu:function(e){var t,n,r,i;if(this._map.contextmenu){n=this._map.mouseEventToContainerPoint(e.originalEvent);for(r=0,i=this.options.contextmenuItems.length;r<i;r++){t=this.options.contextmenuItems[r];this._items.push(this._map.contextmenu.insertItem(t,t.index))}this._map.once("contextmenu.hide",this._hideContextMenu,this);this._map.contextmenu.showAt(n,{relatedTarget:this})}},_hideContextMenu:function(){var e,t;for(e=0,t=this._items.length;e<t;e++){this._map.contextmenu.removeItem(this._items[e])}this._items.length=0}};L.Marker.mergeOptions({contextmenu:false,contextmenuItems:[]});L.Marker.addInitHook(function(){if(this.options.contextmenu){this._initContextMenu()}});L.Marker.include(L.Mixin.ContextMenu);L.Path.mergeOptions({contextmenu:false,contextmenuItems:[]});L.Path.addInitHook(function(){if(this.options.contextmenu){this._initContextMenu()}});L.Path.include(L.Mixin.ContextMenu)